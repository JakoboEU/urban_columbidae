---
title: "Cooccurance of Columbidae (based on worldwide records) and resulting urban tolerance"
output: html_notebook
---

```{r setup}
library(dplyr)
library(tidyverse)
library(picante)
library(network)
```

## Load data for our columbidae species present in all localities of the world
```{r}
all_occurance = read_csv(gzfile('../../data/bigquery/columbidae_birdlife__worldwide_ebird_records.csv.gz'))
```
```{r}
head(all_occurance)
```
```{r}
mapping = read_csv('../../data/bigquery/columbidae_birdlife_to_jetz__taxonomic_mapping.csv')
```

```{r}
all_occurance_jetz_pt1 = left_join(all_occurance, mapping, by = c("scientific_name" = "species_name"))
all_occurance_jetz = all_occurance_jetz_pt1 %>% group_by(locality_id, jetz_scientific_name) %>% summarise()
all_occurance_jetz
```

And then join to self using locality ID, which gives us all cooccuring species across the world, with urban tolerance.
```{r}
all_occurance_jetz2 = all_occurance_jetz
names(all_occurance_jetz2) = c('locality_id', 'jetz_scientific_name2')
cooccurance = right_join(all_occurance_jetz, all_occurance_jetz2)
cooccurance = cooccurance[cooccurance$jetz_scientific_name != cooccurance$jetz_scientific_name2,]
```

```{r}
head(cooccurance)
```

Remove locality so we end up with cooccuring species, along with number of patches recorded as cooccuring.
```{r}
cooccurance_details = cooccurance %>% group_by(jetz_scientific_name, jetz_scientific_name2) %>% summarise(recorded_patches = n())
cooccurance_details
```

## Load in our regional pools
```{r}
regional_pools = read_csv('../../data/bigquery/columbidae_jetz__urban_locations.csv')
regional_pools = regional_pools[,c('jetz_scientific_name', 'city_id', 'present_in_city')]
regional_pools
```

Generate all cooccuring species in regional pools
```{r}
regional_pools2 = regional_pools
names(regional_pools2) = c('jetz_scientific_name2', 'city_id', 'present_in_city2')
regional_cooccurance = right_join(regional_pools, regional_pools2)
regional_cooccurance = regional_cooccurance[regional_cooccurance$jetz_scientific_name != regional_cooccurance$jetz_scientific_name2,]
head(regional_cooccurance)
```

```{r}
regional_cooccurance_pairs = regional_cooccurance %>% group_by(jetz_scientific_name, jetz_scientific_name2) %>% summarise(number_of_pools = n(), present_count = sum(present_in_city), present_count2 = sum(present_in_city2), both_present = sum(present_in_city & present_in_city2))
regional_cooccurance_pairs
```

## Create data set of all species that co-occur on eBird localties within our regional pools
Finally we can create all valid pairs of species that could be living in the same patches from our regional pools.
Here we also drop all species where neither pair is present in the city
```{r}
regional_patch_cooccurance = right_join(regional_cooccurance_pairs, cooccurance_details)
regional_patch_cooccurance = regional_patch_cooccurance[!is.na(regional_patch_cooccurance$number_of_pools),]
regional_patch_cooccurance = regional_patch_cooccurance[regional_patch_cooccurance$present_count >= regional_patch_cooccurance$present_count2,]
regional_patch_cooccurance = regional_patch_cooccurance[regional_patch_cooccurance$present_count > 0,]
regional_patch_cooccurance
```


In most of the records above, the number of times they are both present is the same that the number of times only the least dominant is presence.
The exceptions are:
```{r}
regional_patch_cooccurance[regional_patch_cooccurance$present_count2 != regional_patch_cooccurance$both_present,]
```

Problem records we have where they have the same tolerance (67 pairs of species):
```{r}
regional_patch_cooccurance[regional_patch_cooccurance$present_count == regional_patch_cooccurance$present_count2,]
```

Drop duplicate co-occuring pairs by creating a unique key from the two species names (should remove 67 rows)
```{r}
regional_patch_cooccurance = regional_patch_cooccurance %>% rowwise() %>%
  mutate(key = paste0(sort(c(jetz_scientific_name, jetz_scientific_name2)), collapse = '|'))

regional_patch_cooccurance = regional_patch_cooccurance[!duplicated(regional_patch_cooccurance$key),]

regional_patch_cooccurance
```

## Work out MNTD between each species pair:
```{r}
tree <- read.tree("../../data/third_party/phylogeny_jetz__stage2_hackett_mcc_no_neg.tre")
```

```{r}
all_species = unique(c(regional_patch_cooccurance$jetz_scientific_name, regional_patch_cooccurance$jetz_scientific_name2))
tree_pruned_to_columbidae <- ladderize(drop.tip(tree, setdiff(tree$tip.label, all_species)))
```

```{r}
phydist <- cophenetic(tree_pruned_to_columbidae)
```


```{r}
regional_patch_cooccurance$mntd = NA

for(row_i in 1:nrow(regional_patch_cooccurance)) {
  community = data.frame(species1 = c(T, T), species2 = c(T, T))
  names(community) = list(as.character(regional_patch_cooccurance[[row_i,c('jetz_scientific_name')]]), as.character(regional_patch_cooccurance[[row_i,c('jetz_scientific_name2')]]))
  rownames(community) = c('1', '2')

  mntd.community.result <- ses.mntd(as.matrix(community), phydist, null.model="taxa.labels", abundance.weighted=FALSE, runs=99)
  
  regional_patch_cooccurance[row_i,]$mntd = mntd.community.result[1,]$mntd.obs
}

regional_patch_cooccurance$cooccurance_ratio = regional_patch_cooccurance$both_present / regional_patch_cooccurance$number_of_pools
regional_patch_cooccurance
```

# Explore Co-occurance ~ Pair MNTD
```{r}
ggplot(regional_patch_cooccurance, aes(x = mntd, y = cooccurance_ratio)) + geom_point() + geom_smooth(method = "glm", linetype = 2)
```
```{r}
ggplot(regional_patch_cooccurance[regional_patch_cooccurance$cooccurance_ratio > 0,], aes(x = mntd, y = cooccurance_ratio)) + geom_point() + geom_smooth(method = "glm", linetype = 2)
```

## Calculate a status which indicates whether species are in the city together:
```{r}
regional_patch_cooccurance$cooccurance_status = 'Occasional'
regional_patch_cooccurance$cooccurance_status[regional_patch_cooccurance$present_count2 == 0] = 'Never'
regional_patch_cooccurance$cooccurance_status[regional_patch_cooccurance$present_count == regional_patch_cooccurance$present_count2] = 'Always'

regional_patch_cooccurance
```

```{r}
ggplot(regional_patch_cooccurance, aes(x = cooccurance_status, y = mntd)) + geom_boxplot()
```

```{r}
shapiro.test(regional_patch_cooccurance$mntd) 
shapiro.test(log(regional_patch_cooccurance$mntd))
shapiro.test(sqrt(regional_patch_cooccurance$mntd))
```

```{r}
nrow(regional_patch_cooccurance)
mean(regional_patch_cooccurance$mntd)
```

Is there a significant different in the mean MNTD between these groups?
```{r}
regional_patch_cooccurance %>% group_by(cooccurance_status) %>% summarise(mean = mean(mntd), sd = sd(mntd), min = min(mntd), max = max(mntd), total = n())
```

```{r}
t.test(regional_patch_cooccurance$mntd[regional_patch_cooccurance$cooccurance_status == 'Never'], regional_patch_cooccurance$mntd[regional_patch_cooccurance$cooccurance_status == 'Always'])
```

```{r}
kruskal.test(cooccurance_status ~ mntd, data = regional_patch_cooccurance)
```

Not really!

Compare mean MNTD between species that sometimes and never cooccur
```{r}
mean(regional_patch_cooccurance$mntd[regional_patch_cooccurance$cooccurance_ratio > 0])
mean(regional_patch_cooccurance$mntd[regional_patch_cooccurance$cooccurance_ratio == 0])
mean(regional_patch_cooccurance$mntd[regional_patch_cooccurance$cooccurance_ratio == 1])


t.test(regional_patch_cooccurance$mntd[regional_patch_cooccurance$cooccurance_ratio > 0], regional_patch_cooccurance$mntd[regional_patch_cooccurance$cooccurance_ratio == 0])
```
Again, not significantly different

Which species that are evolutionary close together, occur rarely?
```{r}
regional_patch_cooccurance[regional_patch_cooccurance$mntd < 20, c('jetz_scientific_name', 'jetz_scientific_name2', 'cooccurance_status', 'mntd')]
```

## What if we exclude species that never occur in cities?  Are urban avoiders changing this result?
```{r}
urban_birds = unique(regional_pools$jetz_scientific_name[regional_pools$present_in_city == T])
regional_patch_cooccurance_of_urban_birds = regional_patch_cooccurance[regional_patch_cooccurance$jetz_scientific_name %in% urban_birds & regional_patch_cooccurance$jetz_scientific_name2 %in% urban_birds,]

ggplot(regional_patch_cooccurance_of_urban_birds, aes(x = mntd, y = cooccurance_ratio)) + geom_point() + geom_smooth(method = "glm", linetype = 2)
```
```{r}
summary(glm(data = regional_patch_cooccurance_of_urban_birds, formula = cooccurance_ratio ~ mntd))
```

## What about if we just look at species with the same trophic niche
Load in trophic niches
```{r}
avonet_jetz = read_csv('../../data/output/urban_traits__trait_axis.csv')
trophic_niche = avonet_jetz[,c('jetz_scientific_name', 'trophic_niche')]
head(trophic_niche)
```
```{r}
regional_patch_cooccurance_of_urban_birds_by_trophic_trait = left_join(regional_patch_cooccurance, trophic_niche)
names(trophic_niche) = c('jetz_scientific_name2', 'trophic_niche2')
regional_patch_cooccurance_of_urban_birds_by_trophic_trait = left_join(regional_patch_cooccurance_of_urban_birds_by_trophic_trait, trophic_niche)

regional_patch_cooccurance_of_urban_birds_by_trophic_trait = regional_patch_cooccurance_of_urban_birds_by_trophic_trait[regional_patch_cooccurance_of_urban_birds_by_trophic_trait$trophic_niche == regional_patch_cooccurance_of_urban_birds_by_trophic_trait$trophic_niche2,]
regional_patch_cooccurance_of_urban_birds_by_trophic_trait
```

```{r}
ggplot(regional_patch_cooccurance_of_urban_birds_by_trophic_trait, aes(x = mntd, y = cooccurance_ratio)) + geom_point() + geom_smooth(method = "glm", linetype = 2)
```
```{r}
summary(glm(data = regional_patch_cooccurance_of_urban_birds_by_trophic_trait, formula = cooccurance_ratio ~ mntd))
```

```{r}
ggplot(regional_patch_cooccurance_of_urban_birds_by_trophic_trait, aes(x = cooccurance_status, y = mntd)) + geom_boxplot()
```

```{r}
regional_patch_cooccurance_of_urban_birds_by_trophic_trait %>% group_by(cooccurance_status) %>% summarise(mean = mean(mntd), sd = sd(mntd), min = min(mntd), max = max(mntd), total = n())
```

```{r}
kruskal.test(cooccurance_status ~ mntd, data = regional_patch_cooccurance_of_urban_birds_by_trophic_trait)
```

# Map Co-occurance using a network plot

## All co-occurance
```{r}
library(GGally)
```

```{r}
regional_patch_cooccurance
```

```{r}
regional_patch_cooccurance$number_of_pools_sqrt = as.integer(sqrt(regional_patch_cooccurance$number_of_pools))

cooccurance_ratio_color_ramp <- colorRampPalette(c("red", "blue"))
cooccurance_ratio_palette = cooccurance_ratio_color_ramp(11)

get_ratio_colour = function(ratio) {
  cooccurance_ratio_palette[round(ratio * 10)]
}

color.gradient <- function(x, colors=c("red","yellow", "green"), colsteps=100) {
  return( colorRampPalette(colors) (colsteps) [ findInterval(x, seq(min(x),max(x), length.out=colsteps)) ] )
}

regional_patch_cooccurance$cooccurance_ratio_colour = color.gradient(regional_patch_cooccurance$cooccurance_ratio)
```


```{r}
ggnet2(regional_patch_cooccurance, label = T, edge.size = "number_of_pools_sqrt", edge.color = "cooccurance_ratio_colour")
ggsave("figures/worldwide_cooccurance.jpg", width=5112, height=5112, units = "px")
```

## Cooccurrance by realm

```{r}
head(regional_pools)
```

```{r}
cities_to_realms = read_csv('../../data/earth_engine/cities_to_realms.csv')
names(cities_to_realms) = c('city_id', 'realm')
cities_to_realms[order(cities_to_realms$realm),]
```

```{r}
cities_to_realms[cities_to_realms$city_id == 4355,]
```

```{r}
cities_in_single_realm = cities_to_realms %>% group_by(city_id) %>% summarise(number_of_realms = n()) %>% filter(number_of_realms == 1)
```

# Here we exclude cities that appear in multiple realms, there are on the edge of a realm and may contains species from multiple realms. This complicates our graphs
```{r}
regional_pools_by_realm = left_join(cities_to_realms, regional_pools)
regional_pools_by_realm = regional_pools_by_realm[!is.na(regional_pools_by_realm$jetz_scientific_name),]
regional_pools_by_realm = regional_pools_by_realm[regional_pools_by_realm$city_id %in% cities_in_single_realm$city_id,]
regional_pools_by_realm
```

```{r}
regional_pools_by_realm_summary = regional_pools_by_realm %>% group_by(realm, jetz_scientific_name) %>% summarise(species_presence_total_pools = n(), species_presence_total_urban = sum(present_in_city))
regional_pools_by_realm_summary
```

```{r}
regional_pools_by_realm2 = regional_pools_by_realm
names(regional_pools_by_realm2) = c('city_id', 'realm', 'jetz_scientific_name2', 'present_in_city2')
urban_cooccurance_by_realm = right_join(regional_pools_by_realm, regional_pools_by_realm2)
urban_cooccurance_by_realm = urban_cooccurance_by_realm[urban_cooccurance_by_realm$jetz_scientific_name != urban_cooccurance_by_realm$jetz_scientific_name2,]
head(urban_cooccurance_by_realm)
```

Restrict down to pairs of species that do occur
```{r}
possible_cooccurrance_by_realm = urban_cooccurance_by_realm %>% group_by(realm, jetz_scientific_name, jetz_scientific_name2) %>% summarise(cooccurance_total_pools = n(), cooccurance_both_urban = sum(present_in_city & present_in_city2))

cooccurrance_by_realm = right_join(cooccurance_details, possible_cooccurrance_by_realm)

cooccurrance_by_realm
```

Add additional columns for plot
```{r}
cooccurrance_by_realm$cooccurance_total_pools_sqrt = as.integer(sqrt(cooccurrance_by_realm$cooccurance_total_pools))
cooccurrance_by_realm$cooccurance_ratio = cooccurrance_by_realm$cooccurance_both_urban / cooccurrance_by_realm$cooccurance_total_pools
cooccurrance_by_realm$cooccurance_ratio_colour = color.gradient(cooccurrance_by_realm$cooccurance_ratio)

cooccurrance_by_realm
```

Summary data for each species for nodes
```{r}
species_presence_by_realm = regional_pools_by_realm %>% group_by(jetz_scientific_name, realm) %>% summarise(
  species_total_pools = n(), 
  species_total_cities = sum(present_in_city),
  species_urban_tolerance = sum(present_in_city) / n())

species_presence_by_realm$urban_tolerance_colour = color.gradient(species_presence_by_realm$species_urban_tolerance)
species_presence_by_realm
```

```{r}
unique(cooccurrance_by_realm$realm)
```

### Palearctic
```{r}
cooccurrance_paleartic = cooccurrance_by_realm[cooccurrance_by_realm$realm == 'Palearctic',]
cooccurrance_paleartic
```

```{r}
cooccurrance_paleartic_net = network(cooccurrance_paleartic)
cooccurrance_paleartic_net
```

```{r}
species_paleartic = data.frame(species_presence_by_realm[species_presence_by_realm$realm == 'Palearctic',])
rownames(species_paleartic) = species_paleartic$jetz_scientific_name
species_paleartic
```

```{r}
ggnet2(cooccurrance_paleartic_net, label = T, edge.size = "cooccurance_total_pools_sqrt", edge.color = "cooccurance_ratio_colour", node.color = species_paleartic[,c('urban_tolerance_colour')], node.size = species_paleartic[,c('species_total_pools')])

ggsave("figures/paleartic_cooccurance.jpg", width=5112, height=5112, units = "px")
```


### Australasia
```{r}
cooccurrance_australasia = cooccurrance_by_realm[cooccurrance_by_realm$realm == 'Australasia',]
cooccurrance_australasia
```

```{r}
cooccurrance_australasia_net = network(cooccurrance_australasia)
cooccurrance_australasia_net
```

```{r}
species_australasia = data.frame(species_presence_by_realm[species_presence_by_realm$realm == 'Australasia',])
rownames(species_australasia) = species_australasia$jetz_scientific_name
species_australasia
```

```{r}
ggnet2(cooccurrance_australasia_net, label = T, edge.size = "cooccurance_total_pools_sqrt", edge.color = "cooccurance_ratio_colour", node.color = species_australasia[,c('urban_tolerance_colour')], node.size = species_australasia[,c('species_total_pools')])

ggsave("figures/australasia_cooccurance.jpg", width=5112, height=5112, units = "px")
```


### Indomalayan
```{r}
cooccurrance_indomalayan = cooccurrance_by_realm[cooccurrance_by_realm$realm == 'Indomalayan',]
cooccurrance_indomalayan
```

```{r}
cooccurrance_indomalayan_net = network(cooccurrance_indomalayan)
cooccurrance_indomalayan_net
```

```{r}
species_indomalayan = data.frame(species_presence_by_realm[species_presence_by_realm$realm == 'Indomalayan',])
rownames(species_indomalayan) = species_indomalayan$jetz_scientific_name
species_indomalayan
```

```{r}
ggnet2(cooccurrance_indomalayan_net, label = T, edge.size = "cooccurance_total_pools_sqrt", edge.color = "cooccurance_ratio_colour", node.color = species_indomalayan[,c('urban_tolerance_colour')], node.size = species_indomalayan[,c('species_total_pools')])

ggsave("figures/indomalayan_cooccurance.jpg", width=5112, height=5112, units = "px")
```

### Neotropic
```{r}
cooccurrance_neotropic = cooccurrance_by_realm[cooccurrance_by_realm$realm == 'Neotropic',]
cooccurrance_neotropic
```

```{r}
cooccurrance_neotropic_net = network(cooccurrance_neotropic)
cooccurrance_neotropic_net
```

```{r}
species_neotropic = data.frame(species_presence_by_realm[species_presence_by_realm$realm == 'Neotropic',])
rownames(species_neotropic) = species_neotropic$jetz_scientific_name
species_neotropic
```

```{r}
ggnet2(cooccurrance_neotropic_net, label = T, edge.size = "cooccurance_total_pools_sqrt", edge.color = "cooccurance_ratio_colour", node.color = species_neotropic[,c('urban_tolerance_colour')], node.size = species_neotropic[,c('species_total_pools')])

ggsave("figures/neotropic_cooccurance.jpg", width=5112, height=5112, units = "px")
```

### Afrotropic
```{r}
cooccurrance_afrotropic = cooccurrance_by_realm[cooccurrance_by_realm$realm == 'Afrotropic',]
cooccurrance_afrotropic
```

```{r}
cooccurrance_afrotropic_net = network(cooccurrance_afrotropic)
cooccurrance_afrotropic_net
```

```{r}
species_afrotropic = data.frame(species_presence_by_realm[species_presence_by_realm$realm == 'Afrotropic',])
rownames(species_afrotropic) = species_afrotropic$jetz_scientific_name
species_afrotropic
```

```{r}
ggnet2(cooccurrance_afrotropic_net, label = T, edge.size = "cooccurance_total_pools_sqrt", edge.color = "cooccurance_ratio_colour", node.color = species_afrotropic[,c('urban_tolerance_colour')], node.size = species_afrotropic[,c('species_total_pools')])

ggsave("figures/afrotropic_cooccurance.jpg", width=5112, height=5112, units = "px")
```

### Nearctic
```{r}
cooccurrance_nearctic = cooccurrance_by_realm[cooccurrance_by_realm$realm == 'Nearctic',]
cooccurrance_nearctic
```

```{r}
cooccurrance_nearctic_net = network(cooccurrance_nearctic)
cooccurrance_nearctic_net
```

```{r}
species_nearctic = data.frame(species_presence_by_realm[species_presence_by_realm$realm == 'Nearctic',])
rownames(species_nearctic) = species_nearctic$jetz_scientific_name
species_nearctic
```

```{r}
ggnet2(cooccurrance_nearctic_net, label = T, edge.size = "cooccurance_total_pools_sqrt", edge.color = "cooccurance_ratio_colour", node.color = species_nearctic[,c('urban_tolerance_colour')], node.size = species_nearctic[,c('species_total_pools')])

ggsave("figures/nearctic_cooccurance.jpg", width=5112, height=5112, units = "px")
```


